<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Attendance Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f3f6fb;
    --card: #ffffff;
    --text: #0b1b2b;
    --muted: #98a2b3;
    --accent: #0b7cff;
    --present: #10b981;
    --absent: #ff5c6c;
    --radius: 16px;
  }

  body[data-theme="dark"]{
    --bg: #071019;
    --card: #0b1220;
    --text: #e6eef6;
    --muted: #9fb6d9;
    --accent: #0ad5a8;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    height: 100%;
    width: 100%;
    overflow-x: hidden;
    font-family: Inter, system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -webkit-text-size-adjust: 100%;
    touch-action: pan-y;
  }

  .app {
    min-height: 100vh;
    min-height: -webkit-fill-available;
    width: 100%;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .card {
    width: 100%;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    background: var(--card);
    padding: 16px;
    padding-top: max(16px, env(safe-area-inset-top));
    padding-bottom: max(80px, env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
  }

  header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(2,6,23,0.06);
  }

  body[data-theme="dark"] header {
    border-bottom-color: rgba(255,255,255,0.06);
  }

  .hdr-left {
    flex: 1;
  }

  h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 800;
    line-height: 1.2;
  }

  .hdr-sub {
    font-size: 13px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.4;
  }

  .theme-toggle {
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 10px;
    border: 1px solid rgba(11,124,255,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    cursor: pointer;
    font-size: 18px;
    flex-shrink: 0;
  }

  body[data-theme="dark"] .theme-toggle {
    border-color: rgba(255,255,255,0.06);
  }

  label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-top: 16px;
    margin-bottom: 8px;
  }

  input, select, textarea {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid rgba(2,6,23,0.06);
    background: var(--bg);
    color: var(--text);
    font-size: 16px;
    font-family: inherit;
    transition: border-color 0.2s;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  body[data-theme="dark"] input, 
  body[data-theme="dark"] select,
  body[data-theme="dark"] textarea { 
    border-color: rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.03);
  }

  .row {
    display: flex;
    gap: 10px;
    width: 100%;
  }

  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    border-radius: 12px;
    background: var(--accent);
    color: #fff;
    border: 0;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    width: 100%;
    font-family: inherit;
    transition: opacity 0.2s;
  }

  .btn:active {
    opacity: 0.8;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(11,124,255,0.12);
  }

  body[data-theme="dark"] .btn.ghost {
    border-color: rgba(255,255,255,0.12);
  }

  .btn.small {
    padding: 10px 14px;
    font-size: 13px;
    border-radius: 10px;
    width: auto;
  }

  .btn.success {
    background: var(--present);
  }

  .btn.danger {
    background: var(--absent);
  }

  .muted {
    color: var(--muted);
    font-size: 13px;
    line-height: 1.5;
  }

  .section {
    margin-top: 24px;
  }

  .section h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 700;
  }

  .students {
    margin-top: 12px;
  }

  .student-item {
    padding: 14px;
    border-radius: 10px;
    background: var(--bg);
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(2,6,23,0.04);
  }

  body[data-theme="dark"] .student-item {
    background: rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.06);
  }

  .student-left {
    font-weight: 700;
    font-size: 15px;
  }

  .student-name {
    color: var(--muted);
    font-size: 13px;
    margin-top: 4px;
  }

  .mark-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
  }

  .mark-list {
    margin-top: 12px;
  }

  .mark-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    border-radius: 12px;
    background: var(--bg);
    border: 1px solid rgba(2,6,23,0.04);
    margin-bottom: 10px;
  }

  body[data-theme="dark"] .mark-row {
    background: rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.06);
  }

  .mark-left {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .enroll {
    font-weight: 800;
    font-size: 15px;
  }

  .sname {
    color: var(--muted);
    margin-top: 4px;
    font-size: 13px;
  }

  .toggle-btn {
    min-width: 90px;
    height: 40px;
    border-radius: 10px;
    border: 0;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.2s;
  }

  .toggle-btn:active {
    opacity: 0.8;
  }

  .toggle-absent {
    background: var(--absent);
  }

  .toggle-present {
    background: var(--present);
  }

  .search-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
  }

  .search-inputs {
    display: flex;
    gap: 10px;
  }

  .search-inputs input {
    flex: 1;
  }

  .search-inputs select {
    flex: 1;
  }

  .footer {
    margin-top: auto;
    padding-top: 24px;
    text-align: center;
    color: var(--muted);
    font-size: 12px;
  }

  .popup-bg {
    position: fixed;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
  }

  .popup {
    background: #071017;
    color: #7fffd4;
    padding: 16px 24px;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
    box-shadow: 0 10px 40px rgba(0,0,0,0.7);
    max-width: 90%;
    text-align: center;
  }

  .modal-content {
    background: var(--card);
    padding: 20px;
    border-radius: 16px;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .spinner {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.24);
    border-top-color: #fff;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .info-box {
    background: #eaf7ff;
    padding: 12px;
    border-radius: 10px;
    border-left: 4px solid var(--accent);
    margin-bottom: 16px;
    font-size: 13px;
    line-height: 1.5;
  }

  body[data-theme="dark"] .info-box {
    background: rgba(10,213,168,0.1);
    border-left-color: var(--accent);
  }

  .student-edit-row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    align-items: center;
  }

  .student-edit-row input {
    flex: 1;
    padding: 12px;
    margin: 0;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }

  .record-card {
    padding: 14px;
    border-radius: 10px;
    background: var(--bg);
    margin-bottom: 10px;
    border: 1px solid rgba(2,6,23,0.04);
  }

  body[data-theme="dark"] .record-card {
    background: rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.06);
  }

  .record-date {
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 6px;
  }

  .record-info {
    color: var(--muted);
    font-size: 13px;
    margin-bottom: 8px;
  }

  .record-status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
  }

  .status-present {
    background: rgba(16,185,129,0.1);
    color: var(--present);
  }

  .status-absent {
    background: rgba(255,92,108,0.1);
    color: var(--absent);
  }

  .status-result-card {
    padding: 16px;
    border-radius: 12px;
    background: var(--bg);
    margin-bottom: 12px;
    border: 1px solid rgba(2,6,23,0.04);
  }

  body[data-theme="dark"] .status-result-card {
    background: rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.06);
  }

  .status-subject {
    font-weight: 700;
    font-size: 15px;
    color: var(--accent);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }

  .stat-box {
    text-align: center;
    padding: 10px;
    background: var(--card);
    border-radius: 8px;
  }

  body[data-theme="dark"] .stat-box {
    background: rgba(0,0,0,0.2);
  }

  .stat-label {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .stat-value {
    font-weight: 700;
    font-size: 18px;
  }

  .progress-bar-container {
    margin-top: 12px;
  }

  .progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 13px;
  }

  .progress-label {
    color: var(--muted);
  }

  .progress-value {
    font-weight: 700;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(2,6,23,0.06);
    border-radius: 4px;
    overflow: hidden;
  }

  body[data-theme="dark"] .progress-bar {
    background: rgba(255,255,255,0.06);
  }

  .progress-fill {
    height: 100%;
    transition: width 0.5s ease;
    border-radius: 4px;
  }

  .account-picker-card {
    padding: 12px;
    background: #f6faff;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid rgba(11,124,255,0.1);
  }

  body[data-theme="dark"] .account-picker-card {
    background: rgba(10,213,168,0.05);
    border-color: rgba(10,213,168,0.2);
  }

  .account-title {
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .account-info {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 10px;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
  }

  body[data-theme="dark"] ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
  }

  /* iOS style improvements */
  input, select, textarea, button {
    -webkit-appearance: none;
    appearance: none;
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2398a2b3' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
  }

  @media (max-width: 380px) {
    h1 {
      font-size: 18px;
    }

    .btn {
      padding: 12px 16px;
      font-size: 14px;
    }

    .toggle-btn {
      min-width: 80px;
      height: 36px;
      font-size: 13px;
    }

    .stat-value {
      font-size: 16px;
    }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="card" id="mainCard">
      <header>
        <div class="hdr-left">
          <h1 id="title">Dashboard</h1>
          <div class="hdr-sub" id="hdrInfo">Dept ¬∑ Sem ¬∑ Subject</div>
          <div id="totalClasses" class="muted" style="margin-top:6px;display:none">Total classes: 0</div>
        </div>
        <div>
          <button id="themeBtn" class="theme-toggle" aria-label="Toggle theme" type="button">‚òÄÔ∏è</button>
        </div>
      </header>

      <div id="views">
        <!-- LOGIN -->
        <div id="loginView">
          <label>Email</label>
          <input id="liEmail" type="email" autocomplete="username" placeholder="you@gmail.com">
          <label>Password</label>
          <input id="liPass" type="password" autocomplete="current-password" placeholder="Password">
          <div class="btn-group">
            <button id="btnLogin" class="btn" type="button">Login</button>
          </div>
          <div class="btn-group">
            <button id="btnShowSignup" class="btn ghost" type="button">Sign Up</button>
            <button id="btnShowStatus" class="btn success" type="button">üßæ Student Status</button>
          </div>
          <div style="margin-top:12px;text-align:center">
            <a href="#" id="lnkForgot" class="muted" style="text-decoration:underline">Forgot Password?</a>
          </div>
        </div>

        <!-- SIGNUP -->
        <div id="signupView" style="display:none">
          <div class="info-box">
            <strong>Important:</strong> Share your Google Sheet with hubattendance@gmail.com as Editor before signing up.
          </div>
          <label>Email</label>
          <input id="suEmail" type="email" placeholder="you@gmail.com">
          
          <div class="row" style="margin-top:6px">
            <div style="flex:1">
              <label>Department</label>
              <select id="suDept">
                <option>CSE</option>
                <option>Civil</option>
                <option>Electrical</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Semester</label>
              <select id="suSem">
                <option>1st</option>
                <option>2nd</option>
                <option>3rd</option>
                <option>4th</option>
                <option>5th</option>
                <option>6th</option>
              </select>
            </div>
          </div>

          <label>Subject</label>
          <input id="suSubject" type="text" placeholder="e.g. Physics">
          
          <label>Google Sheet ID</label>
          <input id="suSheetId" type="text" placeholder="Spreadsheet ID">
          
          <label>Create Password</label>
          <input id="suPass" type="password" placeholder="Create password">
          
          <label>Confirm Password</label>
          <input id="suConfirm" type="password" placeholder="Confirm password">

          <div class="btn-group">
            <button id="btnSignup" class="btn" type="button">Sign Up Now</button>
          </div>
          <div class="btn-group">
            <button id="btnBackToLogin" class="btn ghost" type="button">Back to Login</button>
          </div>
        </div>

        <!-- FORGOT PASSWORD -->
        <div id="forgotView" style="display:none">
          <label>Enter your email</label>
          <input id="fpEmail" type="email" placeholder="you@gmail.com">
          
          <div class="btn-group">
            <button id="btnSendToken" class="btn" type="button">Send Reset Token</button>
          </div>
          <div class="btn-group">
            <button id="btnBackFromForgot" class="btn ghost" type="button">Back to Login</button>
          </div>

          <div id="forgotAccounts" style="margin-top:16px"></div>

          <div id="forgotStep2" style="display:none;margin-top:16px">
            <label>Account</label>
            <select id="fpAccount"></select>
            
            <label>Token</label>
            <input id="fpToken" type="text" placeholder="Enter 6-digit token">
            
            <label>New Password</label>
            <input id="fpNew" type="password" placeholder="Enter new password">

            <div class="btn-group">
              <button id="btnReset" class="btn" type="button">Reset Password</button>
            </div>
            <div class="btn-group">
              <button id="btnForgotCancel" class="btn ghost" type="button">Cancel</button>
            </div>
          </div>
        </div>

        <!-- STUDENT STATUS CHECKER -->
        <div id="studentStatusView" style="display:none">
          <div class="info-box" style="background:#e0f7fa;border-left-color:#00acc1">
            <strong>üìä Student Portal:</strong> Check your attendance status without logging in.
          </div>

          <label>Department</label>
          <select id="statusDept">
            <option value="">Select Department</option>
            <option>CSE</option>
            <option>Civil</option>
            <option>Electrical</option>
          </select>

          <label>Semester</label>
          <select id="statusSem">
            <option value="">Select Semester</option>
            <option>1st</option>
            <option>2nd</option>
            <option>3rd</option>
            <option>4th</option>
            <option>5th</option>
            <option>6th</option>
          </select>

          <label>Enrollment Number</label>
          <input id="statusEnroll" type="text" placeholder="Enter your enrollment number">

          <div class="btn-group">
            <button id="btnCheckStatus" class="btn success" type="button">üßæ Check Status</button>
          </div>
          <div class="btn-group">
            <button id="btnBackToLoginFromStatus" class="btn ghost" type="button">Back to Login</button>
          </div>

          <div id="statusResults" style="display:none;margin-top:20px">
            <h3 style="margin:16px 0 12px 0;font-size:16px">üìà Attendance Summary</h3>
            <div id="statusResultsContent"></div>
          </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboardView" style="display:none">
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <h3 style="margin:0">Students</h3>
              <button id="btnEditStudents" class="btn small" type="button">Edit Students</button>
            </div>
            
            <div class="students" id="studentsList">
              <div class="muted">No students yet</div>
            </div>

            <div id="studentsEditor" style="display:none;margin-top:16px">
              <div id="studentsEditorRows"></div>
              <div class="btn-group">
                <button id="btnAddStudent" class="btn small" type="button">+ Add</button>
                <button id="btnSaveStudents" class="btn small success" type="button">Save</button>
                <button id="btnCloseStudents" class="btn small ghost" type="button">Cancel</button>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Mark Attendance</h3>
            <div class="muted" style="margin-bottom:12px">Tap student to toggle Present/Absent</div>

            <div class="mark-controls">
              <div style="display:flex;gap:10px;align-items:center">
                <label style="margin:0;flex-shrink:0">Date:</label>
                <input id="quickDate" type="date" style="flex:1">
              </div>
              <button id="markBtn" class="btn" type="button">Start Marking</button>
            </div>

            <div id="markArea" style="display:none">
              <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0 12px 0">
                <div class="muted" style="font-weight:600">Marking List</div>
              </div>

              <div class="mark-list" id="markList"></div>

              <div class="btn-group">
                <button id="btnSaveAttendance" class="btn success" type="button">Save Attendance</button>
              </div>
              <div class="btn-group">
                <button id="btnCancelMark" class="btn ghost" type="button">Cancel</button>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Search Records</h3>
            <div class="search-row">
              <div class="search-inputs">
                <input id="searchEnroll" placeholder="Enrollment">
                <select id="filterStatus">
                  <option>All</option>
                  <option>Present</option>
                  <option>Absent</option>
                </select>
              </div>
              <button id="btnSearch" class="btn small" type="button">Search</button>
            </div>

            <div id="recordsArea" style="margin-top:12px"></div>
          </div>

          <div style="margin-top:24px">
            <button id="btnLogout" class="btn ghost" type="button">Logout</button>
          </div>
        </div>
      </div>

      <div class="footer">¬© ragibuddin</div>
    </div>
  </div>

  <div id="popupContainer" style="display:none"></div>

<script>
  const $ = id => document.getElementById(id);

  // THEME
  const THEME_KEY = 'att_theme';
  function applyTheme(theme){
    if(theme === 'dark') 
      document.body.setAttribute('data-theme','dark'); 
    else 
      document.body.removeAttribute('data-theme');
    
    const btn = $('themeBtn'); 
    if(btn) btn.textContent = (theme === 'dark') ? 'üåô' : '‚òÄÔ∏è';
    
    try{ 
      localStorage.setItem(THEME_KEY, theme); 
    } catch(e){}
  }

  (function initTheme(){
    try{
      const saved = localStorage.getItem(THEME_KEY);
      if(saved === 'dark' || saved === 'light') 
        applyTheme(saved);
      else 
        applyTheme((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light');
    } catch(e){ 
      applyTheme('light'); 
    }
  })();

  // Set today's date
  function setTodayDate(){
    const dateInput = $('quickDate');
    if(dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
    }
  }

  // Attach listeners after DOM ready
  document.addEventListener('DOMContentLoaded', ()=>{
    setTodayDate();

    // Theme toggle
    const themeBtn = $('themeBtn');
    if(themeBtn) themeBtn.addEventListener('click', ()=>{
      const cur = localStorage.getItem(THEME_KEY) || (document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');
      applyTheme(cur === 'light' ? 'dark' : 'light');
    });

    // Auth/navigation
    $('btnSignup').addEventListener('click', doSignup);
    $('btnBackToLogin').addEventListener('click', ()=> show('login'));
    $('btnSendToken').addEventListener('click', startForgot);
    $('btnBackFromForgot').addEventListener('click', ()=> show('login'));
    $('btnReset').addEventListener('click', doReset);
    $('btnForgotCancel').addEventListener('click', ()=> show('login'));
    $('btnLogin').addEventListener('click', doLogin);
    $('btnShowSignup').addEventListener('click', ()=> show('signup'));
    $('btnShowStatus').addEventListener('click', ()=> show('studentStatus'));
    $('lnkForgot').addEventListener('click', (e)=>{ e.preventDefault(); show('forgot'); });

    // Student status
    $('btnBackToLoginFromStatus').addEventListener('click', ()=> show('login'));
    $('btnCheckStatus').addEventListener('click', checkStudentStatus);

    // Students
    $('btnEditStudents').addEventListener('click', openStudentsEditor);
    $('btnAddStudent').addEventListener('click', addStudentRow);
    $('btnSaveStudents').addEventListener('click', saveStudents);
    $('btnCloseStudents').addEventListener('click', closeStudentsEditor);

    // Attendance
    $('markBtn').addEventListener('click', startMark);
    $('btnSaveAttendance').addEventListener('click', confirmSave);
    $('btnCancelMark').addEventListener('click', cancelMark);

    // Search & logout
    $('btnSearch').addEventListener('click', loadRecords);
    $('btnLogout').addEventListener('click', logout);

    const pass = $('liPass'); 
    if(pass) pass.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
  });

  // Helpers
  function hackerPopup(msg, timeout=1800){
    const c = $('popupContainer');
    c.innerHTML = `<div class="popup-bg"><div class="popup">${msg}</div></div>`;
    c.style.display='block';
    setTimeout(()=>{ c.style.display='none'; c.innerHTML=''; }, timeout);
  }

  function setBtnLoading(btn, loading, text){ 
    if(!btn) return; 
    if(loading){ 
      btn._orig = btn.innerHTML; 
      btn.disabled = true; 
      btn.innerHTML = `<span class="spinner"></span>${text||'Processing...'}`;
    } else { 
      btn.disabled = false; 
      if(btn._orig) btn.innerHTML = btn._orig; 
    } 
  }

  function escapeHtml(s){ 
    return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
  }

  // View management
  function show(view){
    ['login','signup','forgot','studentStatus','dashboard'].forEach(v=>{ 
      const el=$(v+'View'); 
      if(el) el.style.display = (v===view)?'block':'none'; 
    });
    
    $('title').innerText = view==='dashboard' ? 'Dashboard' 
      : view==='signup' ? 'Sign Up' 
      : view==='forgot' ? 'Forgot Password'
      : view==='studentStatus' ? 'Student Status'
      : 'Attendance Login';
    
    const tc = $('totalClasses'); 
    if(tc) tc.style.display = (view==='dashboard') ? 'block' : 'none';
  }
  show('login');

  // Total classes
  function updateTotalClasses(){
    if(!currentAccount || !currentAccount.accountId){ 
      const el=$('totalClasses'); 
      if(el) el.textContent = 'Total classes: 0'; 
      return; 
    }
    google.script.run
      .withSuccessHandler(count=>{ 
        const el=$('totalClasses'); 
        if(el) el.textContent = 'Total classes: ' + (Number(count)||0); 
      })
      .getTotalClasses(currentAccount.accountId);
  }

  // SIGNUP
  function doSignup(){
    const btn = $('btnSignup'); 
    setBtnLoading(btn,true,'Signing up...');
    
    const email = $('suEmail').value.trim().toLowerCase(); 
    const dept = $('suDept').value; 
    const sem = $('suSem').value; 
    const subject = $('suSubject').value.trim();
    const sheetId = $('suSheetId').value.trim(); 
    const pass = $('suPass').value; 
    const confirm = $('suConfirm').value;
    
    if(!email || !sheetId || !pass || pass !== confirm){ 
      hackerPopup('Fill all fields & match passwords'); 
      setBtnLoading(btn,false); 
      return; 
    }
    
    google.script.run
      .withSuccessHandler(res=>{ 
        setBtnLoading(btn,false); 
        if(res && res.success){ 
          hackerPopup('‚úÖ Account created'); 
          show('login'); 
        } else 
          hackerPopup(res && res.message ? res.message : 'Signup failed'); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Server error during signup'); 
      })
      .signup(email,dept,sem,subject,sheetId,pass);
  }

  // FORGOT / RESET
  function startForgot(){
    const btn = $('btnSendToken'); 
    setBtnLoading(btn,true,'Sending...');
    const email = $('fpEmail').value.trim().toLowerCase();
    
    if(!email){ 
      hackerPopup('Enter email'); 
      setBtnLoading(btn,false); 
      return; 
    }
    
    google.script.run
      .withSuccessHandler(accs=>{ 
        setBtnLoading(btn,false); 
        const holder=$('forgotAccounts'); 
        if(!accs||accs.length===0){ 
          holder.innerHTML=''; 
          hackerPopup('No accounts for this email'); 
          return; 
        } 
        holder.innerHTML = accs.map(a=>`
          <div class="account-picker-card">
            <div class="account-title">${escapeHtml(a.subject||'(no subject)')}</div>
            <div class="account-info">${escapeHtml(a.dept)} ¬∑ ${escapeHtml(a.semester)}</div>
            <button class="btn small" type="button" onclick="sendTokenFor('${a.accountId}')">Send Token</button>
          </div>
        `).join(''); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Server error'); 
      })
      .getAccountsByEmail(email);
  }

  function sendTokenFor(accountId){
    const pc=$('popupContainer'); 
    pc.innerHTML = `<div class="popup-bg"><div class="popup">Sending token...</div></div>`; 
    pc.style.display='block';
    
    google.script.run
      .withSuccessHandler(res=>{ 
        pc.style.display='none'; 
        pc.innerHTML=''; 
        if(res && res.success){ 
          hackerPopup('Token sent to email'); 
          if(res.token) alert('Token (testing): ' + res.token); 
          $('fpAccount').innerHTML = `<option value="${accountId}">${accountId.substr(0,8)}</option>`; 
          $('forgotStep2').style.display='block'; 
        } else 
          hackerPopup(res && res.message ? res.message : 'Failed to send token'); 
      })
      .withFailureHandler(()=>{ 
        pc.style.display='none'; 
        pc.innerHTML=''; 
        hackerPopup('Server error sending token'); 
      })
      .sendResetToken(accountId);
  }

  function doReset(){
    const btn = $('btnReset'); 
    setBtnLoading(btn,true,'Resetting...');
    const accountId = $('fpAccount').value; 
    const token = $('fpToken').value.trim(); 
    const newPwd = $('fpNew').value;
    
    if(!accountId || !token || !newPwd){ 
      hackerPopup('Fill all fields'); 
      setBtnLoading(btn,false); 
      return; 
    }
    
    google.script.run
      .withSuccessHandler(res=>{ 
        setBtnLoading(btn,false); 
        if(res && res.success){ 
          hackerPopup('‚úÖ Password Reset'); 
          show('login'); 
        } else 
          hackerPopup(res && res.message ? res.message : 'Reset failed'); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Server error during reset'); 
      })
      .resetPassword(accountId, token, newPwd);
  }

  // LOGIN & ACCOUNT PICKER
  function doLogin(){
    const btn = $('btnLogin'); 
    setBtnLoading(btn,true,'Logging in...');
    const email = $('liEmail').value.trim().toLowerCase(); 
    const pass = $('liPass').value;
    
    if(!email || !pass){ 
      hackerPopup('Email and password required'); 
      setBtnLoading(btn,false); 
      return; 
    }
    
    google.script.run
      .withSuccessHandler(res=>{ 
        setBtnLoading(btn,false); 
        if(res && res.success){ 
          const accs = res.accounts || []; 
          if(accs.length===1) 
            selectAccount(accs[0]); 
          else 
            showAccountPicker(accs); 
        } else 
          hackerPopup(res && res.message ? res.message : 'Invalid credentials'); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Server error during login'); 
      })
      .login(email,pass);
  }

  function showAccountPicker(accounts){
    if(!accounts || accounts.length===0) return hackerPopup('No accounts found');
    
    const html = accounts.map((a,idx)=>`
      <div class="account-picker-card">
        <div class="account-title">${escapeHtml(a.subject||'(no subject)')}</div>
        <div class="account-info">${escapeHtml(a.dept)} ¬∑ ${escapeHtml(a.semester)}</div>
        <button class="btn small" type="button" onclick="pickAccount(${idx})">Open</button>
      </div>
    `).join('');
    
    const pc=$('popupContainer'); 
    pc.innerHTML = `
      <div class="popup-bg">
        <div class="modal-content">
          <h3 style="margin-bottom:12px">Select Account</h3>
          ${html}
          <button class="btn ghost" type="button" onclick="closePopup()">Cancel</button>
        </div>
      </div>
    `; 
    pc.style.display='block';
    window._loginAccounts = accounts;
  }

  function pickAccount(idx){ 
    const arr = window._loginAccounts||[]; 
    const a = arr[idx]; 
    closePopup(); 
    if(a) selectAccount(a); 
  }

  function closePopup(){ 
    const pc=$('popupContainer'); 
    pc.style.display='none'; 
    pc.innerHTML=''; 
    window._loginAccounts=null; 
  }

  function selectAccount(acc){
    currentAccount = acc;
    $('hdrInfo').innerText = (acc.dept||'') + ' ¬∑ ' + (acc.semester||'') + ' ¬∑ ' + (acc.subject||'');
    show('dashboard');
    loadStudents(); 
    loadRecords(); 
    updateTotalClasses();
    
    google.script.run
      .withSuccessHandler(isFirst=>{ 
        if(isFirst) openStudentsEditor(); 
      })
      .isFirstLogin(currentAccount.accountId);
    
    hackerPopup('Login Successful');
  }

  // STUDENT STATUS CHECKER
  function checkStudentStatus(){
    const btn = $('btnCheckStatus');
    setBtnLoading(btn, true, 'Checking...');
    
    const dept = $('statusDept').value;
    const sem = $('statusSem').value;
    const enroll = $('statusEnroll').value.trim();
    
    if(!dept || !sem || !enroll) {
      hackerPopup('Please fill all fields');
      setBtnLoading(btn, false);
      return;
    }
    
    google.script.run
      .withSuccessHandler(res => {
        setBtnLoading(btn, false);
        
        if(res && res.success) {
          renderStudentStatus(res.data);
        } else {
          hackerPopup(res && res.message ? res.message : 'No records found');
          $('statusResults').style.display = 'none';
        }
      })
      .withFailureHandler(() => {
        setBtnLoading(btn, false);
        hackerPopup('Error fetching data');
      })
      .getStudentStatus(dept, sem, enroll);
  }

  function renderStudentStatus(data){
    const container = $('statusResultsContent');
    
    if(!data || Object.keys(data).length === 0) {
      container.innerHTML = '<div class="muted">No attendance records found.</div>';
      $('statusResults').style.display = 'block';
      return;
    }
    
    container.innerHTML = Object.entries(data).map(([subject, stats]) => {
      const percentage = stats.total > 0 ? ((stats.present / stats.total) * 100).toFixed(2) : '0.00';
      const barWidth = percentage;
      const isGood = percentage >= 75;
      
      return `
        <div class="status-result-card">
          <div class="status-subject">üìö ${escapeHtml(subject)}</div>
          
          <div class="status-stats">
            <div class="stat-box">
              <div class="stat-label">Total</div>
              <div class="stat-value">${stats.total}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Present</div>
              <div class="stat-value" style="color:var(--present)">${stats.present}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Absent</div>
              <div class="stat-value" style="color:var(--absent)">${stats.absent}</div>
            </div>
          </div>
          
          <div class="progress-bar-container">
            <div class="progress-info">
              <span class="progress-label">Attendance %</span>
              <span class="progress-value" style="color:${isGood ? 'var(--present)' : 'var(--absent)'}">${percentage}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${barWidth}%;background:${isGood ? 'var(--present)' : 'var(--absent)'}"></div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    $('statusResults').style.display = 'block';
  }

  // STUDENTS / ATTENDANCE / RECORDS
  let currentAccount = null; 
  let students = []; 
  let marking = [];

  function loadStudents(){ 
    if(!currentAccount) return; 
    google.script.run
      .withSuccessHandler(res=>{ 
        students = res || []; 
        renderStudents(); 
      })
      .withFailureHandler(()=>{ 
        hackerPopup('Could not load students'); 
      })
      .getStudentsByAccount(currentAccount.accountId); 
  }

  function renderStudents(){ 
    const list=$('studentsList'); 
    if(!students||students.length===0){ 
      list.innerHTML='<div class="muted">No students yet. Tap "Edit Students" to add.</div>'; 
      return; 
    } 
    list.innerHTML = students.map(s=>`
      <div class="student-item">
        <div>
          <div class="student-left">${escapeHtml(s.enroll)}</div>
          <div class="student-name">${escapeHtml(s.name||'')}</div>
        </div>
      </div>
    `).join(''); 
  }

  function openStudentsEditor(){ 
    const rows=$('studentsEditorRows'); 
    rows.innerHTML=''; 
    const items = students.length ? students : [{enroll:'',name:''}]; 
    items.forEach((s,i)=> {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'student-edit-row';
      rowDiv.innerHTML = `
        <input id="se_enroll_${i}" placeholder="Enrollment" value="${escapeHtml(s.enroll||'')}" />
        <input id="se_name_${i}" placeholder="Name" value="${escapeHtml(s.name||'')}" />
        <button class="btn small danger" type="button" onclick="removeEditorRow(${i})">√ó</button>
      `;
      rows.appendChild(rowDiv);
    });
    $('studentsEditor').style.display='block'; 
  }

  function addStudentRow(){ 
    const rows=$('studentsEditorRows'); 
    const idx=rows.children.length; 
    const rowDiv = document.createElement('div');
    rowDiv.className = 'student-edit-row';
    rowDiv.innerHTML = `
      <input id="se_enroll_${idx}" placeholder="Enrollment" />
      <input id="se_name_${idx}" placeholder="Name" />
      <button class="btn small danger" type="button" onclick="removeEditorRow(${idx})">√ó</button>
    `;
    rows.appendChild(rowDiv);
  }

  function removeEditorRow(i){ 
    const rows=$('studentsEditorRows'); 
    if(rows.children[i]) rows.removeChild(rows.children[i]); 
  }

  function closeStudentsEditor(){ 
    $('studentsEditor').style.display='none'; 
  }

  function saveStudents(){ 
    const btn=$('btnSaveStudents'); 
    setBtnLoading(btn,true,'Saving...'); 
    const rows=$('studentsEditorRows'); 
    const updated=[]; 
    
    for(let i=0;i<rows.children.length;i++){ 
      const enrollEl = $(`se_enroll_${i}`);
      const nameEl = $(`se_name_${i}`);
      const enroll = enrollEl ? enrollEl.value.trim() : ''; 
      const name = nameEl ? nameEl.value.trim() : ''; 
      if(enroll) updated.push({ enroll, name }); 
    } 
    
    google.script.run
      .withSuccessHandler(res=>{ 
        setBtnLoading(btn,false); 
        if(res && res.success){ 
          students = updated; 
          hackerPopup('‚úÖ Students saved'); 
          closeStudentsEditor(); 
          renderStudents(); 
        } else 
          hackerPopup(res && res.message ? res.message : 'Failed to save'); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Server error saving students'); 
      })
      .saveStudentsByAccount(currentAccount.accountId, updated); 
  }

  function startMark(){ 
    const btn=$('markBtn'); 
    setBtnLoading(btn,true,'Checking...'); 
    
    if(!students||students.length===0){ 
      hackerPopup('No students to mark. Add students first.'); 
      setBtnLoading(btn,false); 
      return; 
    } 
    
    const date = $('quickDate').value || new Date().toISOString().slice(0,10); 
    
    google.script.run
      .withSuccessHandler(canSave=>{ 
        setBtnLoading(btn,false); 
        if(!canSave){ 
          hackerPopup('Attendance already saved for this date'); 
          return; 
        } 
        marking = students.map(s=>({ enroll:s.enroll, name:s.name||'', status:'Absent' })); 
        renderMarkList(); 
        $('markArea').style.display='block'; 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Error checking attendance'); 
      })
      .canSaveAttendance(currentAccount.accountId, date); 
  }

  function renderMarkList(){ 
    const c=$('markList'); 
    if(!marking||marking.length===0){ 
      c.innerHTML='<div class="muted">No students to mark</div>'; 
      return; 
    } 
    
    c.innerHTML = marking.map((m,i)=>`
      <div class="mark-row">
        <div class="mark-left">
          <div class="enroll">${escapeHtml(m.enroll)}</div>
          <div class="sname">${escapeHtml(m.name||'')}</div>
        </div>
        <button id="tbtn_${i}" class="toggle-btn ${m.status==='Present'?'toggle-present':'toggle-absent'}" type="button" onclick="toggleMark(${i})">${m.status}</button>
      </div>
    `).join(''); 
  }

  function toggleMark(i){ 
    if(!marking[i]) return; 
    marking[i].status = marking[i].status==='Absent' ? 'Present' : 'Absent'; 
    const btn = $('tbtn_'+i); 
    if(btn){ 
      btn.textContent = marking[i].status; 
      btn.className = 'toggle-btn ' + (marking[i].status==='Present' ? 'toggle-present' : 'toggle-absent');
    } 
  }

  function cancelMark(){ 
    $('markArea').style.display='none'; 
    marking=[]; 
  }

  function confirmSave(){ 
    const btn=$('btnSaveAttendance'); 
    setBtnLoading(btn,true,'Saving...'); 
    
    if(!marking||marking.length===0){ 
      hackerPopup('No marking data'); 
      setBtnLoading(btn,false); 
      return; 
    } 
    
    const payload={ 
      date: $('quickDate').value || new Date().toISOString().slice(0,10), 
      students: marking 
    }; 
    
    google.script.run
      .withSuccessHandler(res=>{ 
        setBtnLoading(btn,false); 
        if(res && res.success){ 
          hackerPopup('‚úÖ Attendance saved'); 
          cancelMark(); 
          loadRecords(); 
          updateTotalClasses(); 
        } else 
          hackerPopup(res && res.message ? res.message : 'Failed to save'); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Server error saving attendance'); 
      })
      .saveAttendanceByAccount(currentAccount.accountId, payload); 
  }

  function loadRecords(){ 
    const btn=$('btnSearch'); 
    setBtnLoading(btn,true,'Loading...'); 
    const filter={ 
      status: $('filterStatus').value, 
      search: $('searchEnroll').value.trim() 
    }; 
    
    google.script.run
      .withSuccessHandler(res=>{ 
        setBtnLoading(btn,false); 
        renderRecords(res||[]); 
      })
      .withFailureHandler(()=>{ 
        setBtnLoading(btn,false); 
        hackerPopup('Could not load records'); 
      })
      .getAttendanceByAccount(currentAccount.accountId, filter); 
  }

  function renderRecords(records){ 
    const a=$('recordsArea'); 
    if(!records||records.length===0){ 
      a.innerHTML='<div class="muted">No records found</div>'; 
      return; 
    } 
    
    a.innerHTML = records.map(r=>`
      <div class="record-card">
        <div class="record-date">${escapeHtml(r.Date)}</div>
        <div class="record-info">${escapeHtml(r.Department)} ¬∑ ${escapeHtml(r.Semester)} ¬∑ ${escapeHtml(r.Subject)}</div>
        <div style="margin-top:8px">
          <strong>${escapeHtml(r.Enroll)}</strong> ¬∑ 
          <span class="record-status ${r.Status==='Present'?'status-present':'status-absent'}">${escapeHtml(r.Status)}</span>
        </div>
      </div>
    `).join(''); 
  }

  function logout(){ 
    currentAccount=null; 
    students=[]; 
    marking=[]; 
    show('login'); 
    hackerPopup('Logged out');
  }

</script>
</body>
</html>
